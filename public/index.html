<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Arcade on Base - Pacman</title>
  <style>
    canvas { border: 1px solid black; }
    #gameInfo { margin-top: 20px; }
  </style>
</head>
<body>
  <button id="connectWallet">Connect Wallet</button>
  <button id="submitScore" disabled>Submit Score</button>
  <button id="claimPrize" disabled>Claim Prize</button>
  <p>Score: <span id="score">0</span></p>
  <canvas id="gameCanvas" width="400" height="400"></canvas>
  <div id="gameInfo"></div>

  <script src="https://cdn.ethers.io/lib/ethers-5.7.umd.min.js"></script>
  <script>
    // Pacman Game
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    let score = 0;
    let pacman = { x: 200, y: 200, size: 20, speed: 5 };
    let dots = [];

    // Generate dots
    for (let i = 0; i < 20; i++) {
      dots.push({ x: Math.random() * 380 + 10, y: Math.random() * 380 + 10, eaten: false });
    }

    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      // Draw Pacman
      ctx.beginPath();
      ctx.arc(pacman.x, pacman.y, pacman.size, 0.2 * Math.PI, 1.8 * Math.PI);
      ctx.lineTo(pacman.x, pacman.y);
      ctx.fillStyle = 'yellow';
      ctx.fill();
      ctx.closePath();

      // Draw dots
      dots.forEach(dot => {
        if (!dot.eaten) {
          ctx.beginPath();
          ctx.arc(dot.x, dot.y, 5, 0, 2 * Math.PI);
          ctx.fillStyle = 'white';
          ctx.fill();
        }
      });
    }

    function movePacman(event) {
      switch (event.key) {
        case 'ArrowUp': pacman.y -= pacman.speed; break;
        case 'ArrowDown': pacman.y += pacman.speed; break;
        case 'ArrowLeft': pacman.x -= pacman.speed; break;
        case 'ArrowRight': pacman.x += pacman.speed; break;
      }
      checkCollision();
      draw();
    }

    function checkCollision() {
      dots.forEach(dot => {
        if (!dot.eaten && Math.abs(pacman.x - dot.x) < 15 && Math.abs(pacman.y - dot.y) < 15) {
          dot.eaten = true;
          score += 10;
          document.getElementById('score').textContent = score;
        }
      });
    }

    document.addEventListener('keydown', movePacman);
    draw();

    // Blockchain Integration
    const contractAddress = "YOUR_CONTRACT_ADDRESS";
    const abi = [ /* Paste ABI from Hardhat artifacts after compilation */ ];
    let provider, signer, contract;

    async function connectWallet() {
      if (window.ethereum) {
        provider = new ethers.providers.Web3Provider(window.ethereum);
        await provider.send("eth_requestAccounts", []);
        signer = provider.getSigner();
        contract = new ethers.Contract(contractAddress, abi, signer);
        document.getElementById('connectWallet').disabled = true;
        document.getElementById('submitScore').disabled = false;
        document.getElementById('claimPrize').disabled = false;
        updateGameInfo();
      } else {
        alert("Install MetaMask!");
      }
    }

    async function submitScore() {
      try {
        const tx = await contract.submitScore(score);
        await tx.wait();
        alert("Score submitted!");
        updateGameInfo();
      } catch (e) {
        console.error(e);
        alert("Error submitting score");
      }
    }

    async function claimPrize() {
      try {
        const tx = await contract.claimPrize(0); // Game ID 0 for Pacman
        await tx.wait();
        alert("Prize claimed!");
        updateGameInfo();
      } catch (e) {
        console.error(e);
        alert("Error claiming prize");
      }
    }

    async function updateGameInfo() {
      const [gameId, timeLeft] = await contract.getActiveGame();
      const highScore = await contract.highScores(gameId, await signer.getAddress());
      document.getElementById('gameInfo').innerHTML = `
        Active Game: ${gameId === 0 ? 'Pacman' : 'TBD'}<br>
        Time Left: ${Math.floor(timeLeft / 3600)}h ${Math.floor((timeLeft % 3600) / 60)}m<br>
        Your High Score: ${highScore.toString()}
      `;
    }

    document.getElementById('connectWallet').addEventListener('click', connectWallet);
    document.getElementById('submitScore').addEventListener('click', submitScore);
    document.getElementById('claimPrize').addEventListener('click', claimPrize);
  </script>
</body>
</html>
